{% extends "base.html" %}

{% block title %}Registro de Observación - Arteterapia{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Progress Header -->
            <div class="text-center mb-4">
                <a href="{{ url_for('workshop_bp.detail', workshop_id=session.workshop_id) }}"
                    class="text-muted text-decoration-none d-inline-block mb-3"
                    aria-label="Cancelar y volver al taller">
                    <i class="bi bi-arrow-left" aria-hidden="true"></i> Cancelar
                </a>
                <h5 class="text-muted mb-2">{{ participant.name }}</h5>
                {% if is_redo %}
                <span class="badge bg-info mb-2">
                    <i class="bi bi-arrow-clockwise"></i> Editando observación
                </span>
                {% endif %}
                <p class="text-muted small">{{ session.prompt[:60] }}{% if session.prompt|length > 60 %}...{% endif %}
                </p>
                <div class="progress" style="height: 4px;" role="progressbar"
                    aria-valuenow="{{ ((question_index + 1) / total_questions * 100)|int }}" aria-valuemin="0"
                    aria-valuemax="100" aria-label="Progreso de observación">
                    <div class="progress-bar" id="observationProgress"
                        style="width: {{ ((question_index + 1) / total_questions * 100)|int }}%"></div>
                </div>
                <p class="text-muted small mt-2">
                    Pregunta <span id="currentQuestion">{{ question_index + 1 }}</span> de {{ total_questions }}
                </p>
            </div>

            <!-- Question Display -->
            <div class="card border-0 shadow-sm observation-card" id="questionCard">
                <div class="card-body p-4">
                    <div class="text-center mb-4" id="questionCategory">
                        <small class="text-muted text-uppercase fw-bold">{{ question.category }}</small>
                        {% if question.subcategory %}
                        <br><small class="text-muted">{{ question.subcategory }}</small>
                        {% endif %}
                    </div>
                    <h1 class="h4 text-center mb-4" id="questionText">{{ question.text }}</h1>

                    <div class="d-grid gap-3" id="answerButtons" role="group" aria-label="Opciones de respuesta">
                        {% for key, label in answer_options.items() %}
                        <button class="btn btn-lg btn-outline-primary answer-btn" data-action="submit-answer"
                            data-answer-value="{{ key }}" id="answer_{{ key }}" aria-label="Responder {{ label }}">
                            {{ label }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Freeform Notes (shown at the end) -->
            <div class="card border-0 shadow-sm observation-card d-none" id="notesCard">
                <div class="card-body p-4">
                    <h2 class="h4 text-center mb-4">Observaciones adicionales</h2>
                    <p class="text-muted text-center mb-4">
                        Optionalmente puede agregar notas u observaciones adicionales sobre esta sesión
                    </p>
                    <div class="mb-4">
                        <label for="freeformNotes" class="sr-only">Observaciones adicionales</label>
                        <textarea class="form-control" id="freeformNotes" rows="5"
                            placeholder="Escriba aquí sus observaciones..."
                            aria-label="Observaciones adicionales"></textarea>
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-lg btn-primary" data-action="complete-observation"
                            aria-label="Finalizar registro de observación">
                            Finalizar registro
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Observation configuration for ObservationFlow module
    const observationConfig = {
        currentQuestionId: "{{ question.id }}",
        currentIndex: {{ question_index }},
    totalQuestions: { { total_questions } },
    previousAnswers: { { previous_answers | tojson | safe } },
    isRedo: { { 'true' if is_redo else 'false' } }
    };
</script>
{% endblock %}
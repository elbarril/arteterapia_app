{% extends "base.html" %}

{% block title %}Registro de Observación - Arteterapia{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Progress Header -->
            <div class="text-center mb-4">
                <a href="{{ url_for('workshop_bp.detail', workshop_id=session.workshop_id) }}"
                    class="text-muted text-decoration-none d-inline-block mb-3">
                    <i class="bi bi-arrow-left"></i> Cancelar
                </a>
                <h5 class="text-muted mb-2">{{ participant.name }}</h5>
                {% if is_redo %}
                <span class="badge bg-info mb-2">
                    <i class="bi bi-arrow-clockwise"></i> Editando observación
                </span>
                {% endif %}
                <p class="text-muted small">{{ session.prompt[:60] }}{% if session.prompt|length > 60 %}...{% endif %}
                </p>
                <div class="progress" style="height: 4px;">
                    <div class="progress-bar" role="progressbar" id="observationProgress"
                        style="width: {{ ((question_index + 1) / total_questions * 100)|int }}%"></div>
                </div>
                <p class="text-muted small mt-2">
                    Pregunta <span id="currentQuestion">{{ question_index + 1 }}</span> de {{ total_questions }}
                </p>
            </div>

            <!-- Question Display -->
            <div class="card border-0 shadow-sm observation-card" id="questionCard">
                <div class="card-body p-4">
                    <div class="text-center mb-4" id="questionCategory">
                        <small class="text-muted text-uppercase fw-bold">{{ question.category }}</small>
                        {% if question.subcategory %}
                        <br><small class="text-muted">{{ question.subcategory }}</small>
                        {% endif %}
                    </div>
                    <h4 class="text-center mb-4" id="questionText">{{ question.text }}</h4>

                    <div class="d-grid gap-3" id="answerButtons">
                        {% for key, label in answer_options.items() %}
                        <button class="btn btn-lg btn-outline-primary answer-btn" onclick="submitAnswer('{{ key }}')"
                            id="answer_{{ key }}">
                            {{ label }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Freeform Notes (shown at the end) -->
            <div class="card border-0 shadow-sm observation-card d-none" id="notesCard">
                <div class="card-body p-4">
                    <h4 class="text-center mb-4">Observaciones adicionales</h4>
                    <p class="text-muted text-center mb-4">
                        Optionalmente puede agregar notas u observaciones adicionales sobre esta sesión
                    </p>
                    <div class="mb-4">
                        <textarea class="form-control" id="freeformNotes" rows="5"
                            placeholder="Escriba aquí sus observaciones..."></textarea>
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-lg btn-primary" onclick="completeObservation()">
                            Finalizar registro
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentQuestionId = "{{ question.id }}";
    let currentIndex = {{ question_index }};
    const totalQuestions = {{ total_questions }};
    const previousAnswers = {{ previous_answers| tojson | safe }};
    const isRedo = {{ 'true' if is_redo else 'false' }};

    // Highlight the current answer if it was previously answered
    function highlightPreviousAnswer() {
        const previousAnswer = previousAnswers[currentQuestionId];
        if (previousAnswer) {
            const answerBtn = document.getElementById('answer_' + previousAnswer);
            if (answerBtn) {
                answerBtn.classList.add('previously-answered');
            }
        }
    }

    // Call on page load
    document.addEventListener('DOMContentLoaded', highlightPreviousAnswer);

    function submitAnswer(answer) {
        // Disable buttons during submission
        const buttons = document.querySelectorAll('.answer-btn');
        buttons.forEach(btn => btn.disabled = true);

        fetch("{{ url_for('observation_bp.process_answer') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question_id: currentQuestionId,
                answer: answer
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.has_more) {
                        // Update to next question
                        currentQuestionId = data.next_question.id;
                        currentIndex = data.question_index;

                        document.getElementById('questionText').textContent = data.next_question.text;
                        document.getElementById('currentQuestion').textContent = currentIndex + 1;

                        // Update category
                        let categoryHTML = '<small class="text-muted text-uppercase fw-bold">' + data.next_question.category + '</small>';
                        if (data.next_question.subcategory) {
                            categoryHTML += '<br><small class="text-muted">' + data.next_question.subcategory + '</small>';
                        }
                        document.getElementById('questionCategory').innerHTML = categoryHTML;

                        // Update progress
                        const progress = ((currentIndex + 1) / totalQuestions * 100);
                        document.getElementById('observationProgress').style.width = progress + '%';

                        // Remove previous highlighting
                        buttons.forEach(btn => {
                            btn.classList.remove('previously-answered');
                            btn.disabled = false;
                        });

                        // Highlight if this question was previously answered
                        highlightPreviousAnswer();
                    } else {
                        // Show notes card
                        document.getElementById('questionCard').classList.add('d-none');
                        document.getElementById('notesCard').classList.remove('d-none');
                    }
                } else {
                    showModal.alert(data.message || 'Error al procesar respuesta');
                    buttons.forEach(btn => btn.disabled = false);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showModal.alert('Error de conexión');
                buttons.forEach(btn => btn.disabled = false);
            });
    }

    function completeObservation() {
        const notes = document.getElementById('freeformNotes').value;

        fetch("{{ url_for('observation_bp.complete_observation') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                freeform_notes: notes
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = data.redirect_url;
                } else {
                    showModal.alert(data.message || 'Error al guardar');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showModal.alert('Error de conexión');
            });
    }
</script>
{% endblock %}